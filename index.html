<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‹•ç”»ãƒªãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«</title>
<link rel="icon" href="favicon.png" type="image/png">

<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background: #fff5f5; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #ef5350; }
    
    /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼: æŸ”ã‚‰ã‹ã„èµ¤ (#ef5350 / #d32f2f) */
    h1 { margin-top: 0; color: #d32f2f; margin-bottom: 5px; }
    .desc { color: #555; margin-bottom: 25px; font-size: 0.9em; background: #ffebee; padding: 15px; border-radius: 6px; line-height: 1.6; border-left: 5px solid #ef5350; }

    /* ã‚¹ãƒ†ãƒƒãƒ— */
    .step-section { margin-bottom: 25px; padding: 20px; border: 1px solid #ffcdd2; border-radius: 8px; background: #fff; }
    .step-header { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; color: #c62828; }
    .step-num { 
        background: #ef5350; color: white; width: 28px; height: 28px; border-radius: 50%; 
        display: inline-flex; justify-content: center; align-items: center; margin-right: 10px; 
        font-weight: bold; font-size: 0.9em;
    }

    /* ç·¨é›†ã‚¨ãƒªã‚¢ */
    .batch-area { background: #fff9fa; padding: 15px; border-radius: 6px; border: 1px solid #ffcdd2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .batch-area input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« */
    .file-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    .file-table th { background: #ffebee; padding: 10px; text-align: left; font-size: 0.9em; color: #c62828; border-bottom: 2px solid #ffcdd2; }
    .file-table td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .file-table tr:last-child td { border-bottom: none; }
    
    /* å…¥åŠ›æ¬„ */
    .name-input-group { display: flex; align-items: center; }
    .name-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; width: 100%; box-sizing: border-box; }
    .name-input:focus { border-color: #ef5350; outline: none; background: #fffdfd; }
    .ext-label { color: #888; font-size: 0.9em; margin-left: 5px; white-space: nowrap; }
    
    .orig-name { font-size: 0.9em; color: #666; }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .action-area { margin-top: 30px; text-align: center; border-top: 2px solid #ffcdd2; padding-top: 20px; }
    button { cursor: pointer; transition: 0.3s; font-size: 1em; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; }
    
    .btn-apply { background: #ef5350; color: white; box-shadow: 0 2px 5px rgba(239, 83, 80, 0.2); }
    .btn-apply:hover { background: #d32f2f; }

    #btn-dir { background: #6c757d; color: white; padding: 12px 30px; font-size: 1.1em; border-radius: 30px; }
    #btn-dir:hover { background: #5a6268; }
    #btn-dir.ready { background: #28a745; }

    #btn-run { 
        background: #28a745; 
        color: white; 
        padding: 15px 60px; 
        font-size: 1.2em; 
        border-radius: 30px; 
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); 
        margin-top: 20px;
    }
    #btn-run:hover { 
        background: #1e7e34; 
        transform: translateY(-2px); 
    }
    #btn-run:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    #status-msg { margin-top: 15px; font-weight: bold; color: #28a745; min-height: 1.2em; }
    .note { font-size: 0.8em; color: #666; margin-left: 5px; }
</style>
</head>
<body>

<div class="container">
    <h1>å‹•ç”»ãƒªãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«</h1>
    <p class="desc">
        å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬é¸æŠã—ã€åå‰ã‚’å¤‰æ›´ã—ã¦ã‚³ãƒ”ãƒ¼ä¿å­˜ã—ã¾ã™ã€‚<br>
        æ‹¡å¼µå­ï¼ˆ.mp4ç­‰ï¼‰ã¯è‡ªå‹•ã§ç¶­æŒã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
    </p>

    <div class="step-section">
        <div class="step-header"><span class="step-num">1</span> ç·¨é›†ã—ãŸã„å‹•ç”»ã‚’é¸æŠ (è¤‡æ•°å¯)</div>
        <input type="file" id="inp-files" accept="video/*" multiple style="font-size:1em;">
        <p id="count-info" style="font-size:0.9em; color:#666; margin-top:5px;"></p>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">2</span> åå‰ã‚’å¤‰æ›´</div>
        
        <div class="batch-area">
            <span style="font-weight:bold; font-size:0.9em; color:#c62828;">ä¸€æ‹¬è¨­å®š:</span>
            <input type="text" id="batch-name" placeholder="å…±é€šã®æ–‡å­— (ä¾‹: æ¸‹è°·åº—)">
            <select id="batch-type" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                <option value="prefix_only">ï¼‹ è‡ªåˆ†ã§å…¥åŠ› (æ¥é ­è¾ã®ã¿å…¥åŠ›)</option>
                <option value="number">ï¼‹ é€£ç•ª (01, 02...)</option>
                <option value="keep">ï¼‹ å…ƒã®åå‰</option>
            </select>
            <button class="btn-apply" id="btn-batch-apply">é©ç”¨ã™ã‚‹</button>
        </div>

        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ffcdd2; border-radius: 4px;">
            <table class="file-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                        <th>å¤‰æ›´å¾Œã®åå‰ (æ‹¡å¼µå­ã¯è‡ªå‹•ä»˜ä¸)</th>
                    </tr>
                </thead>
                <tbody id="file-list-body">
                    <tr><td colspan="2" style="text-align:center; color:#999; padding:20px;">å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="action-area">
        <div id="folder-status" style="margin-bottom:10px; color:#d32f2f; font-weight:bold;">âš  ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <button id="btn-dir">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
        <br>
        <button id="btn-run" disabled>ä¿å­˜ã‚’å®Ÿè¡Œã™ã‚‹ (ã‚³ãƒ”ãƒ¼ä½œæˆ)</button>
        <div id="status-msg"></div>
    </div>
</div>

<script>
    // Elements
    const inpFiles = document.getElementById('inp-files');
    const fileListBody = document.getElementById('file-list-body');
    const countInfo = document.getElementById('count-info');
    const btnBatchApply = document.getElementById('btn-batch-apply');
    const batchNameInput = document.getElementById('batch-name');
    const batchTypeSelect = document.getElementById('batch-type');
    const btnDir = document.getElementById('btn-dir');
    const btnRun = document.getElementById('btn-run');
    const folderStatus = document.getElementById('folder-status');
    const statusMsg = document.getElementById('status-msg');
    
    // Data
    let filesData = []; // { file, origBase, ext, newName, id }
    let targetDirHandle = null;

    // 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    inpFiles.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        filesData = [];
        // åå‰ã‚’åˆ†è§£ã—ã¦ä¿å­˜
        for (let i = 0; i < files.length; i++) {
            const f = files[i];
            const lastDotIdx = f.name.lastIndexOf('.');
            let base = f.name;
            let ext = "";
            if (lastDotIdx > 0) {
                base = f.name.substring(0, lastDotIdx);
                ext = f.name.substring(lastDotIdx); 
            }

            filesData.push({
                id: i,
                file: f,
                origBase: base,
                ext: ext,
                newName: "" 
            });
        }
        
        countInfo.innerText = `${files.length} å€‹ã®å‹•ç”»ã‚’é¸æŠä¸­`;
        renderList();
        checkReady();
    });

    // ãƒªã‚¹ãƒˆæç”»
    function renderList() {
        fileListBody.innerHTML = "";

        for (let i = 0; i < filesData.length; i++) {
            const item = filesData[i];
            
            const tr = document.createElement('tr');
            
            // 1. å…ƒã®åå‰ã‚»ãƒ«
            const tdOrig = document.createElement('td');
            tdOrig.innerHTML = `<span class="orig-name">${item.origBase}${item.ext}</span>`;

            // 2. å¤‰æ›´å¾Œã®åå‰ã‚»ãƒ«
            const tdNew = document.createElement('td');
            const group = document.createElement('div');
            group.className = 'name-input-group';

            const input = document.createElement('input');
            input.type = "text";
            input.className = "name-input";
            input.value = item.newName;
            input.placeholder = item.origBase;
            
            input.oninput = (e) => {
                filesData[i].newName = e.target.value;
            };

            const extSpan = document.createElement('span');
            extSpan.className = 'ext-label';
            extSpan.innerText = item.ext;

            group.appendChild(input);
            group.appendChild(extSpan);
            tdNew.appendChild(group);

            tr.appendChild(tdOrig);
            tr.appendChild(tdNew);
            fileListBody.appendChild(tr);
        }
    }

    // 2. ä¸€æ‹¬å‘½åæ©Ÿèƒ½
    btnBatchApply.addEventListener('click', () => {
        let prefix = batchNameInput.value.trim();
        const type = batchTypeSelect.value;
        const inputs = document.querySelectorAll('.name-input');

        // å…¥åŠ›ãŒã‚ã‚Šã€ã‹ã¤æœ«å°¾ãŒã€Œ_ã€ã§ãªã‘ã‚Œã°ã€Œ_ã€ã‚’è‡ªå‹•ä»˜ä¸
        if (prefix && !prefix.endsWith('_')) {
            prefix += '_';
        }

        filesData.forEach((item, index) => {
            let finalName = "";

            if (type === 'keep') {
                finalName = prefix + item.origBase;
            } else if (type === 'number') {
                const num = String(index + 1).padStart(2, '0');
                finalName = prefix + num;
            } else if (type === 'prefix_only') {
                finalName = prefix;
            }

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            item.newName = finalName;
            
            // ç”»é¢æ›´æ–°
            if(inputs[index]) {
                inputs[index].value = finalName;
            }
        });
    });

    // 3. ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
    btnDir.addEventListener('click', async () => {
        try {
            targetDirHandle = await window.showDirectoryPicker();
            folderStatus.innerText = "âœ… ä¿å­˜å…ˆ: " + targetDirHandle.name;
            folderStatus.style.color = "#28a745";
            btnDir.classList.add("ready");
            btnDir.innerText = "å¤‰æ›´ã™ã‚‹";
            checkReady();
        } catch (err) {
            console.log("ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        }
    });

    function checkReady() {
        if (filesData.length > 0 && targetDirHandle) {
            btnRun.disabled = false;
            btnRun.innerText = `${filesData.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹`;
        } else {
            btnRun.disabled = true;
        }
    }

    // 4. å®Ÿè¡Œ (ã‚³ãƒ”ãƒ¼ä¿å­˜)
    btnRun.addEventListener('click', async () => {
        if (!targetDirHandle) return;
        btnRun.disabled = true;
        const total = filesData.length;
        let successCount = 0;

        for (let i = 0; i < total; i++) {
            const item = filesData[i];
            
            let nameToUse = item.newName.trim();
            if (!nameToUse) {
                nameToUse = item.origBase;
            }
            
            let fileName = nameToUse + item.ext;
            fileName = fileName.replace(/[\\/:*?"<>|]/g, '_');
            
            statusMsg.innerText = `ä¿å­˜ä¸­ [${i+1}/${total}]: ${fileName} ...`;

            try {
                const fileHandle = await targetDirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(item.file);
                await writable.close();
                successCount++;
            } catch (err) {
                console.error(err);
            }
        }

        statusMsg.style.color = "#28a745";
        statusMsg.innerText = `å®Œäº†ï¼ ${successCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`;
        alert("ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
        btnRun.disabled = false;
    });

</script>
</body>
</html>
