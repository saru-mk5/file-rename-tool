<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å‹•ç”»ãƒªãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«</title>
<link rel="icon" href="./favicon.png?v=2" type="image/png">

<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background: #fff5f5; color: #333; margin: 0; padding: 20px; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #ef5350; }
    
    /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼: æŸ”ã‚‰ã‹ã„èµ¤ (#ef5350 / #d32f2f) */
    h1 { margin-top: 0; color: #d32f2f; margin-bottom: 5px; }
    /* èª¬æ˜æ–‡ã‚¨ãƒªã‚¢ */
    .desc { color: #555; margin-bottom: 25px; font-size: 0.9em; background: #ffebee; padding: 15px; border-radius: 6px; line-height: 1.6; border-left: 5px solid #ef5350; }

    /* ã‚¹ãƒ†ãƒƒãƒ— */
    .step-section { margin-bottom: 25px; padding: 20px; border: 1px solid #ffcdd2; border-radius: 8px; background: #fff; }
    .step-header { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; color: #c62828; }
    /* ä¸¸æ•°å­— */
    .step-num { 
        background: #ef5350; color: white; width: 28px; height: 28px; border-radius: 50%; 
        display: inline-flex; justify-content: center; align-items: center; margin-right: 10px; 
        font-weight: bold; font-size: 0.9em;
    }

    /* ç·¨é›†ã‚¨ãƒªã‚¢ */
    .batch-area { background: #fff9fa; padding: 15px; border-radius: 6px; border: 1px solid #ffcdd2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .batch-area input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ« */
    .file-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    .file-table th { background: #ffebee; padding: 10px; text-align: left; font-size: 0.9em; color: #c62828; border-bottom: 2px solid #ffcdd2; }
    .file-table td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    .file-table tr:last-child td { border-bottom: none; }

    /* ã‚µãƒ ãƒã‚¤ãƒ« */
    .thumb-img { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; background: #000; border: 1px solid #ccc; }
    
    /* å…¥åŠ›æ¬„ */
    .name-input { width: 95%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
    .orig-name { font-size: 0.85em; color: #777; display: block; margin-bottom: 4px; }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .action-area { margin-top: 30px; text-align: center; border-top: 2px solid #ffcdd2; padding-top: 20px; }
    button { cursor: pointer; transition: 0.3s; font-size: 1em; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; }
    
    /* é©ç”¨ãƒœã‚¿ãƒ³ (ç·‘) */
    .btn-apply { background: #28a745; color: white; box-shadow: 0 2px 5px rgba(40, 167, 69, 0.2); }
    .btn-apply:hover { background: #218838; }

    /* ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãƒœã‚¿ãƒ³ (æœªé¸æŠæ™‚ã¯ã‚°ãƒ¬ãƒ¼ã€å®Œäº†æ™‚ã¯ç·‘) */
    #btn-dir { background: #6c757d; color: white; padding: 12px 30px; font-size: 1.1em; border-radius: 30px; }
    #btn-dir:hover { background: #5a6268; }
    #btn-dir.ready { background: #28a745; }

    /* å®Ÿè¡Œãƒœã‚¿ãƒ³ (ãƒ¡ã‚¤ãƒ³ã®ç·‘ãƒœã‚¿ãƒ³) */
    #btn-run { 
        background: #28a745; /* ç·‘è‰² */
        color: white; 
        padding: 15px 60px; 
        font-size: 1.2em; 
        border-radius: 30px; 
        box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); 
        margin-top: 20px;
    }
    #btn-run:hover { 
        background: #1e7e34; /* æ¿ƒã„ç·‘ */
        transform: translateY(-2px); 
    }
    #btn-run:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

    #status-msg { margin-top: 15px; font-weight: bold; color: #28a745; min-height: 1.2em; }
    
    /* éš ã—è¦ç´  */
    .hidden { display: none; }
</style>
</head>
<body>

<div class="container">
    <h1>å‹•ç”»ãƒªãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«</h1>
    <p class="desc">
        å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬é¸æŠã—ã€åå‰ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚çµ±ä¸€ã®å‘½åè¦å‰‡ä»˜ä¸ã‚‚å¯èƒ½ã§ã™ã€‚<br>
        <strong>â€»æœ€å¤§50ã€œ100å€‹ç¨‹åº¦æ¨å¥¨</strong>
    </p>

    <div class="step-section">
        <div class="step-header"><span class="step-num">1</span> ç·¨é›†ã—ãŸã„å‹•ç”»ã‚’é¸æŠ (è¤‡æ•°å¯)</div>
        <input type="file" id="inp-files" accept="video/*" multiple style="font-size:1em;">
        <p id="count-info" style="font-size:0.9em; color:#666; margin-top:5px;"></p>
    </div>

    <div class="step-section">
        <div class="step-header"><span class="step-num">2</span> åå‰ã‚’å¤‰æ›´</div>
        
        <div class="batch-area">
            <span style="font-weight:bold; font-size:0.9em; color:#c62828;">ä¸€æ‹¬è¨­å®š:</span>
            <input type="text" id="batch-name" placeholder="å…±é€šã®åå‰ (ä¾‹: æ¸‹è°·åº—)">
            <select id="batch-type" style="padding:8px; border-radius:4px; border:1px solid #ccc;">
                <option value="keep">ï¼‹ å…ƒã®åå‰</option>
                <option value="number">ï¼‹ é€£ç•ª (01, 02...)</option>
            </select>
            <button class="btn-apply" id="btn-batch-apply">é©ç”¨ã™ã‚‹</button>
        </div>

        <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ffcdd2; border-radius: 4px;">
            <table class="file-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">ã‚µãƒ ãƒã‚¤ãƒ«</th>
                        <th style="width: 35%;">å…ƒã®åå‰</th>
                        <th>å¤‰æ›´å¾Œã®åå‰ (ç·¨é›†å¯)</th>
                    </tr>
                </thead>
                <tbody id="file-list-body">
                    <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">å‹•ç”»ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="action-area">
        <div id="folder-status" style="margin-bottom:10px; color:#d32f2f; font-weight:bold;">âš  ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <button id="btn-dir">ğŸ“ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</button>
        <br>
        <button id="btn-run" disabled>ä¿å­˜ã‚’å®Ÿè¡Œã™ã‚‹ (ã‚³ãƒ”ãƒ¼ä½œæˆ)</button>
        <div id="status-msg"></div>
    </div>
</div>

<video id="hidden-video" class="hidden" muted playsinline></video>
<canvas id="hidden-canvas" class="hidden"></canvas>

<script>
    // Elements
    const inpFiles = document.getElementById('inp-files');
    const fileListBody = document.getElementById('file-list-body');
    const countInfo = document.getElementById('count-info');
    const btnBatchApply = document.getElementById('btn-batch-apply');
    const batchNameInput = document.getElementById('batch-name');
    const batchTypeSelect = document.getElementById('batch-type');
    const btnDir = document.getElementById('btn-dir');
    const btnRun = document.getElementById('btn-run');
    const folderStatus = document.getElementById('folder-status');
    const statusMsg = document.getElementById('status-msg');
    
    // Thumbnail Generation Elements
    const hiddenVideo = document.getElementById('hidden-video');
    const hiddenCanvas = document.getElementById('hidden-canvas');
    const ctx = hiddenCanvas.getContext('2d');

    // Data
    let filesData = []; // { file, origName, newName, id }
    let targetDirHandle = null;

    // 1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    inpFiles.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        filesData = [];
        fileListBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰
        for (let i = 0; i < files.length; i++) {
            filesData.push({
                id: i,
                file: files[i],
                origName: files[i].name,
                newName: files[i].name // åˆæœŸå€¤ã¯å…ƒã®åå‰
            });
        }
        
        countInfo.innerText = `${files.length} å€‹ã®å‹•ç”»ã‚’é¸æŠä¸­`;
        await renderList();
        checkReady();
    });

    // ãƒªã‚¹ãƒˆæç”» & ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
    async function renderList() {
        fileListBody.innerHTML = "";

        for (let i = 0; i < filesData.length; i++) {
            const item = filesData[i];
            
            const tr = document.createElement('tr');
            
            // 1. ã‚µãƒ ãƒã‚¤ãƒ«ã‚»ãƒ«
            const tdThumb = document.createElement('td');
            const img = document.createElement('img');
            img.className = 'thumb-img';
            img.src = ""; // å¾Œã§ã‚»ãƒƒãƒˆ
            // ã‚µãƒ ãƒã‚¤ãƒ«éåŒæœŸç”Ÿæˆ
            generateThumbnail(item.file).then(url => img.src = url);
            tdThumb.appendChild(img);

            // 2. å…ƒã®åå‰ã‚»ãƒ«
            const tdOrig = document.createElement('td');
            tdOrig.innerHTML = `<span class="orig-name">${item.origName}</span>`;

            // 3. å¤‰æ›´å¾Œã®åå‰ã‚»ãƒ«
            const tdNew = document.createElement('td');
            const input = document.createElement('input');
            input.type = "text";
            input.className = "name-input";
            input.value = item.newName;
            // å…¥åŠ›åŒæœŸ
            input.oninput = (e) => {
                filesData[i].newName = e.target.value;
            };
            tdNew.appendChild(input);

            tr.appendChild(tdThumb);
            tr.appendChild(tdOrig);
            tr.appendChild(tdNew);
            fileListBody.appendChild(tr);
        }
    }

    // ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆé–¢æ•° (Canvasã‚’ä½¿ç”¨)
    async function generateThumbnail(file) {
        return new Promise((resolve) => {
            const url = URL.createObjectURL(file);
            hiddenVideo.src = url;
            hiddenVideo.currentTime = 1.0; // 1ç§’ç›®ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å–å¾—

            // èª­ã¿è¾¼ã¿å®Œäº†å¾…ã¡
            hiddenVideo.onloadeddata = () => {
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æç”»
                setTimeout(() => {
                    hiddenCanvas.width = 160;
                    hiddenCanvas.height = 90;
                    ctx.drawImage(hiddenVideo, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
                    const dataUrl = hiddenCanvas.toDataURL('image/jpeg');
                    // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                    URL.revokeObjectURL(url);
                    resolve(dataUrl);
                }, 200);
            };
            
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ€ãƒŸãƒ¼ç”»åƒ
            hiddenVideo.onerror = () => {
                resolve("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='80' height='45' style='background:%23ccc'><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='10'>No Image</text></svg>");
            };
        });
    }

    // 2. ä¸€æ‹¬å‘½åæ©Ÿèƒ½
    btnBatchApply.addEventListener('click', () => {
        const prefix = batchNameInput.value.trim();
        const type = batchTypeSelect.value;
        const inputs = document.querySelectorAll('.name-input');

        filesData.forEach((item, index) => {
            let ext = "";
            const parts = item.origName.split('.');
            if(parts.length > 1) ext = "." + parts.pop();

            let finalName = "";

            if (prefix === "") {
                // æ¥é ­è¾ãŒãªã„å ´åˆã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ãªã—
                finalName = item.origName; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å¤‰æ›´ãªã—
            } else {
                // æ¥é ­è¾ãŒã‚ã‚‹å ´åˆ
                if (type === 'keep') {
                    // è‡ªç”±è¦å‰‡ï¼ˆå…ƒã®åå‰ï¼‰
                    // ä¾‹: prefix_å…ƒã®åå‰.mp4
                    // æ‹¡å¼µå­ã‚’é™¤ã„ãŸå…ƒã®åå‰ã‚’å–å¾—
                    const baseOrig = item.origName.replace(ext, "");
                    finalName = `${prefix}_${baseOrig}${ext}`;
                } else {
                    // é€£ç•ª
                    // ä¾‹: prefix_01.mp4
                    const num = String(index + 1).padStart(2, '0');
                    finalName = `${prefix}_${num}${ext}`;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            item.newName = finalName;
            // ç”»é¢æ›´æ–°
            if(inputs[index]) inputs[index].value = finalName;
        });
    });

    // 3. ãƒ•ã‚©ãƒ«ãƒ€é¸æŠ
    btnDir.addEventListener('click', async () => {
        try {
            targetDirHandle = await window.showDirectoryPicker();
            folderStatus.innerText = "âœ… ä¿å­˜å…ˆ: " + targetDirHandle.name;
            folderStatus.style.color = "#28a745";
            btnDir.classList.add("ready");
            btnDir.innerText = "å¤‰æ›´ã™ã‚‹";
            checkReady();
        } catch (err) {
            console.log("ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        }
    });

    function checkReady() {
        if (filesData.length > 0 && targetDirHandle) {
            btnRun.disabled = false;
            btnRun.innerText = `${filesData.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹`;
        } else {
            btnRun.disabled = true;
        }
    }

    // 4. å®Ÿè¡Œ (ã‚³ãƒ”ãƒ¼ä¿å­˜)
    btnRun.addEventListener('click', async () => {
        if (!targetDirHandle) return;
        btnRun.disabled = true;
        const total = filesData.length;

        for (let i = 0; i < total; i++) {
            const item = filesData[i];
            let fileName = item.newName.trim();
            
            // ä¸æ­£æ–‡å­—ã®ç½®æ›
            fileName = fileName.replace(/[\\/:*?"<>|]/g, '_');
            
            statusMsg.innerText = `ä¿å­˜ä¸­ [${i+1}/${total}]: ${fileName} ...`;

            try {
                // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦æ›¸ãè¾¼ã¿
                const fileHandle = await targetDirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(item.file);
                await writable.close();
            } catch (err) {
                console.error(err);
                statusMsg.style.color = "red";
                statusMsg.innerText = `ã‚¨ãƒ©ãƒ¼: ${fileName} ã®ä¿å­˜ã«å¤±æ•—`;
            }
        }

        statusMsg.style.color = "#28a745";
        statusMsg.innerText = `å®Œäº†ï¼ ${total}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`;
        alert("å®Œäº†ã—ã¾ã—ãŸï¼");
        btnRun.disabled = false;
    });

</script>
</body>
</html>